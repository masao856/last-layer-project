
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>Last Layer - 完全統合版</title>
  <style>
    body { font-family: sans-serif; background: #000; color: #fff; margin: 0; }
    #background { width: 100%; height: 200px; background-size: cover; background-position: center; }
    #enemyImage { max-height: 160px; display: block; margin: 10px auto; }
    #controls, #log, #combat { padding: 10px; }
    #log { background: #111; height: 160px; overflow-y: auto; margin-top: 10px; }
    button { margin: 6px; }
    #combat { display: none; background: #222; }
  </style>
</head>
<body>

<div id="background"></div>
<img id="enemyImage" src="" alt="" style="display:none;" />

<div id="controls">
  <div>現在地: <span id="distance">0</span>m</div>
  <button onclick="advance()">進む</button>
  <button onclick="retreat()">戻る</button>
</div>

<div id="combat">
  <div><strong>勇者</strong> HP: <span id="playerHp">100</span> / MP: <span id="playerMp">50</span></div>
  <button onclick="attack()">攻撃</button>
  <button onclick="useSkill()">スキル</button>
  <button onclick="defend()">防御</button>
  <button onclick="escape()">逃げる</button>
</div>

<div id="log"></div>

<script>
let distance = 0;
let inCombat = false;
let player = { hp: 100, mp: 50, maxHp: 100, maxMp: 50 };
let enemy = null;

function updateBackground() {
  let bg = "";
  if (distance < 1000) bg = "fork.png";
  else if (distance < 1500) bg = "layer2_a.png";
  else bg = "layer3_a.png";
  document.getElementById("background").style.backgroundImage = `url('images/backgrounds/${bg}')`;
}
function updateDistance() {
  document.getElementById("distance").textContent = distance;
  updateBackground();
}
function log(msg) {
  const entry = document.createElement("div");
  entry.textContent = msg;
  document.getElementById("log").appendChild(entry);
  document.getElementById("log").scrollTop = document.getElementById("log").scrollHeight;
}
function advance() {
  if (inCombat) return log("戦闘中は移動できない！");
  distance += 50;
  log(`${distance}m に進んだ`);
  triggerEvent();
  updateDistance();
}
function retreat() {
  if (inCombat) return log("戦闘中は移動できない！");
  distance = Math.max(0, distance - 50);
  log(`${distance}m に戻った`);
  updateDistance();
}

function triggerEvent() {
  const r = Math.random();
  if (r < 0.05) {
    log("[イベント] 不気味な泉で癒された。HP/MPが全回復！");
    player.hp = player.maxHp;
    player.mp = player.maxMp;
    updateStatus();
  } else if (r < 0.10) {
    log("[イベント] 宝箱発見！ポーションを手に入れた！");
  } else if (r < 0.15) {
    log("[イベント] 罠にかかった！HPが10減少！");
    player.hp = Math.max(0, player.hp - 10);
    updateStatus();
  } else if (r < 0.40) {
    startCombat("skeleton_soldier.png", "スケルトン・ソルジャー");
  }
}

function updateStatus() {
  document.getElementById("playerHp").textContent = player.hp;
  document.getElementById("playerMp").textContent = player.mp;
}

function startCombat(enemyImage, name) {
  inCombat = true;
  enemy = { name: name, hp: 40 };
  document.getElementById("enemyImage").src = `/last-layer-project/images/${enemyImage}`;
  document.getElementById("enemyImage").style.display = "block";
  document.getElementById("combat").style.display = "block";
  log(`[戦闘] ${name}が現れた！`);
}

function attack() {
  const dmg = 10;
  enemy.hp -= dmg;
  log(`[攻撃] ${enemy.name}に${dmg}ダメージ！`);
  checkEnemy();
}
function useSkill() {
  if (player.mp < 10) return log("[スキル] MPが足りない！");
  const dmg = 20;
  player.mp -= 10;
  enemy.hp -= dmg;
  log(`[スキル] ${enemy.name}に${dmg}ダメージ！`);
  updateStatus();
  checkEnemy();
}
function defend() {
  log("[防御] 構えをとった！");
}
function escape() {
  if (Math.random() < 0.5) {
    log("[逃走] 成功した！");
    endCombat();
  } else {
    log("[逃走] 失敗！");
  }
}
function checkEnemy() {
  if (enemy.hp <= 0) {
    log(`[戦闘] ${enemy.name}を倒した！`);
    endCombat();
  }
}
function endCombat() {
  inCombat = false;
  document.getElementById("enemyImage").style.display = "none";
  document.getElementById("combat").style.display = "none";
  enemy = null;
}
updateDistance();
updateStatus();
</script>
</body>
</html>
